# Raspberry Pi K3s Cluster Setup Script

This script automates the setup of a Kubernetes cluster on Raspberry Pi devices using K3s. It also configures the system with optimizations, installs `fail2ban` for security, and allows for flexible configuration through various parameters.

## Prerequisites

- A set of Raspberry Pi devices running Raspberry Pi OS.
- SSH access to each Raspberry Pi.
- Ensure each Raspberry Pi has an SD card with Raspberry Pi OS installed.

## Parameters

The script accepts the following parameters:

1. **ROLE**: Defines whether the Raspberry Pi will act as a `master` or `worker` in the Kubernetes cluster.
2. **IP_SUFFIX**: The last part of the static IP address for the Raspberry Pi. For example, if you want the IP to be `192.168.123.201`, you would pass `201` as the `IP_SUFFIX`.
3. **MASTER_SUFFIX**: The last part of the IP address of the master node. This is optional and defaults to `201`. Used to construct the full IP, e.g., `192.168.123.201`.
4. **NODE_TOKEN**: The token generated by the master node, required for worker nodes to join the cluster. This is mandatory for worker nodes.
5. **HOSTNAME**: The hostname to assign to the Raspberry Pi.

## Usage

### Master Node Setup

To set up a master node, use the following command:

```bash
./setup_k3s.sh master <IP_SUFFIX> <MASTER_SUFFIX> "" <HOSTNAME>
```

- **Example**: To set up a master node with IP `192.168.123.201` and hostname `raspi-master`, run:
  ```bash
  ./setup_k3s.sh master 201 201 "" "raspi-master"
  ```

### Worker Node Setup

To set up a worker node, first, retrieve the `NODE_TOKEN` from the master node:

1. SSH into the master node.
2. Run the following command to get the `NODE_TOKEN`:
   ```bash
   sudo cat /var/lib/rancher/k3s/server/node-token
   ```
3. Copy the token for use in the worker node setup.

Then, on the worker node, run:

```bash
./setup_k3s.sh worker <IP_SUFFIX> <MASTER_SUFFIX> <NODE_TOKEN> <HOSTNAME>
```

- **Example**: To set up a worker node with IP `192.168.123.202`, connecting to a master node at `192.168.123.201`, with hostname `raspi-worker-01`, run:
  ```bash
  ./setup_k3s.sh worker 202 201 <NODE_TOKEN> "raspi-worker-01"
  ```
  Replace `<NODE_TOKEN>` with the token you copied from the master node.

## Features

- **Fail2ban Installation**: The script installs and configures `fail2ban` to enhance the security of your Raspberry Pi by preventing brute-force attacks.
- **Static IP Configuration**: Each Raspberry Pi is configured with a static IP address to ensure reliable network communication.
- **Hostname Configuration**: You can set a unique hostname for each Raspberry Pi to easily identify them within your network.
- **K3s Installation**: K3s, a lightweight Kubernetes distribution, is installed and configured either as a master or a worker node depending on the role.

## Example Commands

1. **Master Node**:
   ```bash
   ./setup_k3s.sh master 201 201 "" "raspi-master"
   ```

2. **Worker Node**:
   ```bash
   ./setup_k3s.sh worker 202 201 <NODE_TOKEN> "raspi-worker-01"
   ```

## Conclusion

This script simplifies the setup of a Kubernetes cluster on Raspberry Pi devices by automating key configurations and installations. Follow the examples provided to deploy a fully functional K3s cluster across your Raspberry Pi devices.

---

Feel free to customize the `README.md` further based on your specific needs or additional details!